name: blackbox

on:
  push:
    branches:
      - main
  # non-main branches are handled by pull_request
  pull_request:

jobs:
  test-blackbox:
    runs-on: docker
    container:
      image: codeberg.org/margau/buildenv-uv:latest@sha256:ba79a4aee42607ae983dcab497448decf132e30dd185b005ab8369e7feeac77c

    steps:
      - uses: https://code.forgejo.org/actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
      - name: create venv
        run: uv sync --locked
      - run: mkdir -p out
      - name: build a PDF
        run: uv run paperless-asn-qr-code 0 out/l4731_0.pdf
      - name: check that PDF was created
        run: test -f out/l4731_0.pdf
      - name: check that PDF is not empty
        run: test $(stat -c%s out/l4731_0.pdf) -gt 10000
        # TODO: In the future, we could do a automated "visual" comarision to a reference sheet here.
      - name: upload artifact
        uses: https://code.forgejo.org/forgejo/upload-artifact@cb8afe72b42edc798abfb8fcb556cf660d894245 # v5
        with:
          name: pdf-output
          path: ./out/
